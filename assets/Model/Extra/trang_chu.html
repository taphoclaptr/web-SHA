<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>T√†i li·ªáu √¥n thi</title>
    <link rel="stylesheet" href="./trang_chu.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

</head>
<body>
    <div id="header">
        <h2>T√†i Li·ªáu √în Thi</h2>
        <!-- Ph·∫ßn t√¨m ki·∫øm -->
        <form action="/tim-kiem" method="get">
            <input type="text" name="query" placeholder="Nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm...">
        </form>

        <!-- N√∫t ba g·∫°ch -->
        <div class="menu-icon" onclick="toggleMenu()">‚ò∞</div>

        <!-- Danh s√°ch menu -->
        <div class="menu-list" id="menu">
            <a href="../Extra/trang_chu.html">Trang ch·ªß</a>
            <a href="./Monhoc/Toanhoc/toan_hoc.html">To√°n H·ªçc</a>
            <a href="./Monhoc/Nguvan/ngu_van.html">Ng·ªØ VƒÉn</a>
            <a href="./Monhoc/Vatly/vat_li.html">V·∫≠t L√≠</a>
            <a href="./Monhoc/Hoahoc/hoa_hoc.html">H√≥a H·ªçc</a>
            <a href="./Monhoc/Sinhhoc/sinh_hoc.html">Sinh H·ªçc</a>
            <a href="./Monhoc/Tinhoc/tin_hoc.html">Tin H·ªçc</a>
            <a href="./Monhoc/Ngoaingu/ngoai_ngu.html">Ngo·∫°i Ng·ªØ</a>    
            <a href="./Monhoc/Lichsu/lich_su.html">L·ªãch S·ª≠</a>
            <a href="../Extra/Extra.html"><i class="fas fa-sign-out-alt"></i>Tho√°t ti·ªán √≠ch</a>
        </div>
    </div>

    <!-- Ph·∫ßn n·ªôi dung -->
    <div class="main-wrapper">
        <!-- Qu·∫£ng c√°o tr√°i -->
        <aside class="ad ad-left">
        <h4>QC Tr√°i</h4>
        </aside>

        <!-- N·ªôi dung gallery -->
        <main class="gallery-container">
            <div id="recent-post">
                <h2>üïì G·∫ßn ƒë√¢y</h2>
                <div class="gallery-grid" id="gallery-recent"></div>            
            </div>

            <div id="popular-post">
                <h2>üî• Ph·ªï bi·∫øn</h2>
                <div class="gallery-grid" id="gallery-popular"></div>            
            </div>

        </main>

        <!-- Qu·∫£ng c√°o ph·∫£i -->
        <aside class="ad ad-right">
            <h4>QC Ph·∫£i</h4>
        </aside>
    </div>

    <div id="footer">ƒê√¢y l√† b·∫£ng th·ª≠ nghi·ªám n·∫øu c√≥ g√¨ sai s√≥t xin g√≥p √Ω t·∫°i ƒë√¢y ==>
        <a href="./Monhoc/support.html">G√≥p √Ω</a>
    </div>

    <!-- L·ªánh t√¨m ki·∫øm -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const input = document.querySelector('input[name="query"]');

            const subjects = {
                "to√°n": "./Monhoc/Toanhoc/toan_hoc.html",
                "toan": "./Monhoc/Toanhoc/toan_hoc.html",
                "toan hoc": "./Monhoc/Toanhoc/toan_hoc.html",
                "ng·ªØ vƒÉn": "./Monhoc/Nguvan/ngu_van.html",
                "van": "./Monhoc/Nguvan/ngu_van.html",
                "vƒÉn": "./Monhoc/Nguvan/ngu_van.html",
                "ngu van": "./Monhoc/Nguvan/ngu_van.html",
                "v·∫≠t l√≠": "./Monhoc/Vatly/vat_li.html",
                "vat li": "./Monhoc/Vatly/vat_li.html",
                "l√≠": "./Monhoc/Vatly/vat_li.html",
                "li": "./Monhoc/Vatly/vat_li.html",
                "h√≥a h·ªçc": "./Monhoc/Hoahoc/hoa_hoc.html",
                "hoa h·ªçc": "./Monhoc/Hoahoc/hoa_hoc.html",
                "h√≥a": "./Monhoc/Hoahoc/hoa_hoc.html",
                "hoa": "./Monhoc/Hoahoc/hoa_hoc.html",
                "sinh h·ªçc": "./Monhoc/Sinhhoc/sinh_hoc.html",
                "sinh": "./Monhoc/Sinhhoc/sinh_hoc.html",
                "tin h·ªçc": "./Monhoc/Tinhoc/tin_hoc.html",
                "tin": "./Monhoc/Tinhoc/tin_hoc.html",
                "ngo·∫°i ng·ªØ": "./Monhoc/Ngoaingu/ngoai_ngu.html",
                "ti·∫øng anh": "./Monhoc/Ngoaingu/ngoai_ngu.html",
                "anh": "./Monhoc/Ngoaingu/ngoai_ngu.html",
                "ngoai ngu": "./Monhoc/Ngoaingu/ngoai_ngu.html",
                "l·ªãch s·ª≠": "./Monhoc/Lichsu/lich_su.html",
                "lich su": "./Monhoc/Lichsu/lich_su.html",
                "s·ª≠": "./Monhoc/Lichsu/lich_su.html"
            };

            input.addEventListener("keydown", function (e) {
                if (e.key === "Enter") {
                    e.preventDefault();
                    const rawInput = input.value.trim();    
                    const query = rawInput.toLowerCase();

                    for (let keyword in subjects) {
                        if (query.includes(keyword)) {
                            window.location.href = subjects[keyword];
                            return;
                        }
                    }

                    alert("Kh√¥ng t√¨m th·∫•y m√¥n h·ªçc ph√π h·ª£p.");
                }   
            });
        });
    </script>

    <!-- N√∫t ‚ò∞ -->
    <script>
        function toggleMenu() {
            var menu = document.getElementById("menu");
            if (menu.style.display === "flex") {
                menu.style.opacity = "0";
                setTimeout(() => menu.style.display = "none", 300);
            } else {
                menu.style.display = "flex";
                setTimeout(() => menu.style.opacity = "1", 10);
            }
        }
        document.addEventListener("click", function(event) {
            var menu = document.getElementById("menu");
            var icon = document.querySelector(".menu-icon");
            if (!menu.contains(event.target) && !icon.contains(event.target)) {
                menu.style.display = "none";
            }
        });
    </script>

    <!-- Load gallery t·ª´ file kh√°c -->
    <script>
        const sources = [
            "./Monhoc/Toanhoc/toan_hoc.html",
            "./Monhoc/Nguvan/ngu_van.html",
            "./Monhoc/Vatly/vat_li.html",
            "./Monhoc/Hoahoc/hoa_hoc.html",
            "./Monhoc/Sinhhoc/sinh_hoc.html",
            "./Monhoc/Tinhoc/tin_hoc.html",
            "./Monhoc/Ngoaingu/ngoai_ngu.html",
            "./Monhoc/Lichsu/lich_su.html"
        ];

        async function fetchGalleryCards() {
            const allCards = [];

            for (const src of sources) {
                try {
                    const res = await fetch(src);
                    const htmlText = await res.text();
                    const tempDoc = new DOMParser().parseFromString(htmlText, 'text/html');

                    tempDoc.querySelectorAll('link[rel="stylesheet"]').forEach(link => {
                        if (![...document.head.querySelectorAll('link')].some(l => l.href === link.href)) {
                            const newLink = document.createElement('link');
                            newLink.rel = 'stylesheet';
                            newLink.href = link.href;
                            document.head.appendChild(newLink);
                        }
                    });

                    tempDoc.querySelectorAll('script').forEach(script => {
                        const newScript = document.createElement('script');
                        if (script.src) newScript.src = script.src;
                        else newScript.textContent = script.textContent;
                        document.body.appendChild(newScript);
                    });

                    const cards = tempDoc.querySelectorAll(".gallery-card");
                    cards.forEach(card => {
                        const timeTag = card.querySelector("time");
                        const date = timeTag ? new Date(timeTag.getAttribute("datetime")) : new Date(0);
                        const views = parseInt(card.getAttribute("data-views") || "0");

                        allCards.push({
                            html: card.outerHTML,
                            date: date,
                            views: views
                        });
                    });

                } catch (err) {
                    console.error("L·ªói khi t·∫£i:", src, err);
                }
            }

            // S·∫Øp x·∫øp theo g·∫ßn ƒë√¢y
            const recentCards = [...allCards].sort((a, b) => b.date - a.date);
            const popularCards = [...allCards].sort((a, b) => b.views - a.views);

            // Render
            const renderTo = (list, containerId) => {
                const root = document.getElementById(containerId);
                root.innerHTML = "";
                list.forEach((item, index) => {
                    const temp = document.createElement("div");
                    temp.innerHTML = item.html;
                    const el = temp.firstChild;
                    el.style.animationDelay = `${index * 0.1}s`;
                    el.querySelectorAll("a").forEach(a => a.style.textDecoration = "none");
                    root.appendChild(el);
                });
            };

            renderTo(recentCards, "gallery-recent");
            renderTo(popularCards, "gallery-popular");
        }

        fetchGalleryCards();

        //Ph·∫ßn qu·∫£n l√≠ (G·∫ßn ƒë√¢y,Ph√¥ bi·∫øn)
        //G·∫ßn ƒë√¢y
        const galleryCards = document.querySelectorAll('.gallery-card');
        const recentSection = document.getElementById('recent-posts');

        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];

        const sevenDaysAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
        const sevenDaysAgoStr = sevenDaysAgo.toISOString().split('T')[0];

        const recentPosts = [];

        galleryCards.forEach(card => {
            const timeTag = card.querySelector('time');
            if (!timeTag) return;

            const dateStr = timeTag.getAttribute('datetime'); // L·∫•y ng√†y t·ª´ HTML
            if (!dateStr) return;

            // So s√°nh chu·ªói ng√†y d·∫°ng 'YYYY-MM-DD'
            if (dateStr >= sevenDaysAgoStr && dateStr <= todayStr) {
                recentPosts.push(card.cloneNode(true)); // L∆∞u b·∫£n sao
            }
        });

        // G·∫Øn v√†o khu v·ª±c hi·ªÉn th·ªã
        if (recentPosts.length > 0) {
            recentSection.innerHTML = '';
            recentPosts.forEach(post => recentSection.appendChild(post));
        } else {
            recentSection.innerHTML = '</p>';
        }
        
        // Ph·ªï bi·∫øn 
        document.addEventListener("DOMContentLoaded", function () {
            const cards = document.querySelectorAll(".gallery-card");
            const popularList = document.getElementById("popular-list");
            const cardData = [];

            cards.forEach(card => {
                const id = card.dataset.id;
                const viewCountElem = card.querySelector(".view-count");

                // L·∫•y l∆∞·ª£t xem t·ª´ localStorage, m·∫∑c ƒë·ªãnh 0 n·∫øu ch∆∞a c√≥
                const viewCount = parseInt(localStorage.getItem("views-" + id)) || 0;

                // C·∫≠p nh·∫≠t l·∫°i s·ªë view trong DOM n·∫øu c·∫ßn
                viewCountElem.textContent = viewCount;

                cardData.push({ card, viewCount });
            });

            // S·∫Øp x·∫øp gi·∫£m d·∫ßn theo l∆∞·ª£t xem
            const sortedCards = cardData.sort((a, b) => b.viewCount - a.viewCount);

            // L·∫•y top 20 b√†i
            const top20 = sortedCards.slice(0, 20);

            // Hi·ªÉn th·ªã top 20 v√†o khu v·ª±c ph·ªï bi·∫øn
            top20.forEach(item => {
                const clone = item.card.cloneNode(true);
                popularList.appendChild(clone);
            });
        });

    </script>
</body>
</html>
